<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="index">
    <title>중고 검색기</title>
    <script crossorigin src="./js/react.development.js"></script>
    <script crossorigin src="./js/react-dom.development.js"></script>
    <script crossorigin src="./js/babel.js"></script>

    <script crossorigin src="./js/jquery-3.5.1.js"></script>

    <script crossorigin src="./js/bootstrap.bundle.js"></script>
    <script crossorigin src="./js/bootstrap.js"></script>

    <link rel="stylesheet" href="./css/bootstrap.css">
    <link rel="stylesheet" href="./css/bootstrap-grid.css">
    <link rel="stylesheet" href="./css/bootstrap-reboot.css">

    <meta name="theme-color" content="#563d7c">

    <meta name="author" content="jyk86">
    <meta name="description" content="모든 중고 제품을 한번에 검색할 수 있는 가격 비교 사이트 입니다.">
    <meta property="og:title" content="중고 검색기: 간편한 가격 비교">
    <meta property="og:description" content="모든 중고 제품을 한번에 검색할 수 있는 가격 비교 사이트 입니다.">

    <link rel="canonical" href="https://wjd0r.github.io">

    <style>
        .main {
            position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;
        }

        .navbar-brand {
            padding-top: .75rem;
            padding-bottom: .75rem;
            font-size: 1rem;
            background-color: rgba(0, 0, 0, .25);
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
        }

        .navbar .form-control {
            padding: .75rem 1rem;
            border-width: 0;
            border-radius: 0;
        }

        .form-control-dark {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
            border-color: rgba(255, 255, 255, .1);
        }

        .search-submit {
            display: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        .table-striped tbody tr:hover {
            background-color: rgba(0,0,0,.1);
            cursor: pointer;
        }
    </style>

</head>
<body>
<div id="root"></div>
<script type="text/babel">
    class PriceComparison extends React.Component {
        constructor(props) {
            super(props);

            this.state = {
                query: '',
                lastBuildDate: '',
                total: '',
                start: '',
                display: '',
                items: [],
                count: 0,
                type: '검색전',
            };

        }

        descriptionToCost = () => {
            let reals = [];
            this.state.items.map(item => {
                if (item.description.indexOf("가격") != -1 && item.description.indexOf("원") != -1 && ( item.description.indexOf("판매중") != -1)) {
                    item.cost = item.description.split("가격")[1].split("원")[0].replace(/,/gi, "").replace(/ /g,"") * 1;
                    if (item.description.indexOf("판매중") != -1) item.type = "판매중";
                    if (item.description.indexOf("판매완료") != -1) item.type = "판매완료";
                    if (item.description.indexOf("예약중") != -1) item.type = "예약중";

                    this.setState((prevState) => {
                        return {
                            count: this.state.count + 1,
                            type: '검색중',
                        }
                    });

                    reals.push(item);
                }
            });

            reals.sort((a, b) => a.cost < b.cost ? -1 : a.cost > b.cost ? 1 : 0);

            this.setState((prevState) => {
                return {
                    items: reals,
                }
            });
        }

        getData = async (e) => {

            e.preventDefault();

            $('html').css('cursor', 'wait');

            this.setState((prevState) => {
                return {
                    items: [],
                    count: 0,
                    type: '검색시작',
                }
            });

            await this.getData2(this.state.query, 1).then((responseObject) => {
                const date = new Date(responseObject.lastBuildDate);
                console.log(date);

                this.setState((prevState) => {
                    return {
                        lastBuildDate: date.getFullYear() + "." + (date.getMonth() + 1) + "." + date.getDate(),
                        total: responseObject.total,
                        start: responseObject.start,
                        display: responseObject.display,
                        items: this.state.items.concat(responseObject.items),
                    }
                });
            });

            this.descriptionToCost();

            let cnt = this.state.total;
            cnt = (cnt / 100) > 5 ? 5 : (cnt / 100);

            //console.log("cnt : " + cnt);

            for (let i = 1; i < cnt; i++) {
                await this.getData2(this.state.query, 100 * i).then((responseObject) => {
                    const date = new Date(responseObject.lastBuildDate);
                    console.log(date);

                    this.setState((prevState) => {
                        return {
                            items: this.state.items.concat(responseObject.items),
                        }
                    });
                });

                this.descriptionToCost();
            }

            this.setState((prevState) => {
                return {
                    type: '검색완료',
                }
            });

            $('html').css('cursor', 'default');
        }

        getData2 = (query, start) => new Promise(function(resolve, reject) {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://cors-anywhere.herokuapp.com/https://openapi.naver.com/v1/search/cafearticle?query=' + query + '&display=100&start=' + start + '&sort=sim', true);
            request.setRequestHeader('X-Naver-Client-Id', 'E73v0xFMsyAGr9GrOcID');
            request.setRequestHeader('X-Naver-Client-Secret', 'uvWTcWYkCv');

            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    resolve(responseObject);
                } else {
                    console.log('We reached our target server, but it returned an error');
                    console.log('Possibly handle the error by changing your state.');
                }
            };

            request.onerror = () => {
                console.log('There was a connection error of some sort.');
                console.log('Possibly handle the error by changing your state.');
                reject();
            };

            request.send();
        });

        onChange = (e) => {
            this.setState({query:e.target.value});
        }

        render() {
            return (
                <React.Fragment>
                    <form name="cheapest_finder">
                        <nav className="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
                            <a className="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" className="bi bi-gift-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A2.968 2.968 0 0 1 3 2.506V2.5zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43a.522.522 0 0 0 .023.07zM9 3h2.932a.56.56 0 0 0 .023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0V3z"/>
                                    <path d="M15 7v7.5a1.5 1.5 0 0 1-1.5 1.5H9V7h6zM2.5 16A1.5 1.5 0 0 1 1 14.5V7h6v9H2.5z"/>
                                </svg> 중고 검색기</a>


                            <input className="form-control form-control-dark w-100" type="text" value={this.state.query} onChange={this.onChange} placeholder="제품 입력" aria-label="Search" />
                            <ul className="navbar-nav px-3">
                                <li className="nav-item text-nowrap">
                                    <input className="search-submit" type="submit" onClick={this.getData} value="검색" />
                                    <a className="nav-link" href="#" onClick={this.getData}>
                                        검색 <svg width="1em" height="1em" viewBox="0 0 16 16" className="bi bi-search" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M10.442 10.442a1 1 0 0 1 1.415 0l3.85 3.85a1 1 0 0 1-1.414 1.415l-3.85-3.85a1 1 0 0 1 0-1.415z"/>
                                            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                                        </svg></a>
                                </li>
                            </ul>
                        </nav>
                    </form>
                    <main className="main" role="main" className="col-md-12 ml-sm-auto col-lg-12 px-md-12">
                        <div className="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h2>{this.state.query == '' ? '제품을 입력해주세요' : this.state.query}</h2>
                            <div className="btn-group mb-2 mb-md-0">
                                <button type="button" className="btn btn-sm btn-outline-secondary">
                                    {this.state.type}
                                </button>
                                <button type="button" className="btn btn-sm btn-outline-secondary">
                                    데이터 량 : {this.state.count}
                                </button>
                            </div>
                        </div>
                        <div className="table-responsive">
                            <table className="table table-striped">
                                <thead>
                                    <tr>
                                        <th>구분</th>
                                        <th>제목</th>
                                        <th>가격</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {this.state.items.map(item => {
                                    return (
                                        <tr onClick={() => window.open(item.link ,'_blank')}>
                                            <td>{item.type == '판매중'
                                                ? <span className="badge badge-success">판매중</span>
                                                : <span className="badge badge-secondary">판매완료</span>}</td>
                                            <td><span className="badge badge-primary">{item.cafename}</span> {item.title.replace("<b>","").replace("</b>","").replace(/&lt;/g,"").replace(/&gt;/g,"")}</td>
                                            <td>{item.cost}</td>
                                        </tr>
                                    )
                                })}
                                </tbody>
                            </table>
                        </div>
                    </main>
                </React.Fragment>
            );
        }
    }
</script>
<script type="text/babel">
    ReactDOM.render(<div className="cheapest_finder"><PriceComparison /></div>, document.querySelector('#root'));
</script>
</body>
</html>