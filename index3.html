<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Title</title>

    <script crossorigin src="./js/react.development.js"></script>
    <script crossorigin src="./js/react-dom.development.js"></script>
    <script crossorigin src="./js/babel.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@0.6.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@0.6.0/lib/addons/p5.dom.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="js/partial.js"></script>
    <script src="js/_.js"></script>

    <link rel="stylesheet" href="./css/bootstrap.css">
    <link rel="stylesheet" href="./css/bootstrap-grid.css">
    <link rel="stylesheet" href="./css/bootstrap-reboot.css">

    <style>

        /* 좌측 선택 #2d3e63 */
        /* 배경색 선택 #f3f3f3 */
        /* 파란색 버튼 #337ab7 */
        /* 선택된 버튼 #286090 */
        th {
            background-color: #eee;
            font-size: 14px;
            color: #555;
            font-weight: 400;
            padding: 5px 10px;
        }
        td {
            font-size: 14px;
            padding: 5px 10px;
        }

        input {
            overflow: visible;
            position: relative;
            z-index: 20;
            height: 32px;
            border-radius: 4px;
            background-color: #f4f4f4;
            box-sizing: border-box;
            float: initial;
            border: 0;
            padding-left: 10px;
        }
        input:focus, textarea:focus, select:focus, button:focus {
            outline:none;
        }

        .nav {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 240px;
            border-right: 1px solid #eee;
            overflow: auto;
            height: auto;
            background-color: #30426a;
            color: #b2bfdc;
            font-weight: bold;
        }
        .nav .search-bar{
            display: block;
            overflow: hidden;
            position: relative;
            bottom: auto;
            right: auto;
            padding: 14px 19px 0 20px;
        }
        .nav-panel {
            margin: 3px 21px 0 19px;
            padding: 14px 0 0;
            border-top: 0 none;
            margin-top: 0;
            width: fit-content;
            overflow-y: initial;
        }
        .nav-panel > .panel {
            white-space: initial;
            display: inline-block;
            flex-wrap: wrap;
        }
        .nav-itme {
            overflow: hidden;
            position: relative;
            height: 21px;
            line-height: 21px;
            cursor: pointer;
            display: block;
            padding: auto;
            padding: 0 0 8px 0;
        }
        .nav-itme .link:hover {
            font-weight: bold;
            border-bottom: 4px solid #fee500;
        }
        .article {
            overflow: scroll;
            width: calc(100vw - 241px);
            height: 100vh;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 241px;
        }
        .article-title {
            height: 60px;
            background: #fff;
            padding-left: 15px;
        }
        .article-title-1 {
            padding-top: 7px;
            font-size: 17px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .article-title-2 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 10px;
        }
        .article-content {
            background-color: #f3f3f3;
            padding: 0 15px 15px 15px;
        }
        .article-content:nth-child(2) {
            padding: 15px !important;
        }
        .article-content-box {
            padding: 25px;
            box-shadow: 0 1px 1px rgba(0,0,0,.05);
            background: #fff;
            border: 1px solid transparent;
            border-radius: 2px;
            border-color: #e9e9e9;
        }
        .container_name {
            text-align: left;
            font-size: .9em;
            font-weight: bold;
        }
        .btn {
            margin: .51rem .55rem;
        }
        .table {
            border-collapse: collapse;
            margin-bottom: 0;
        }
        .table-bordered th, .table-bordered td {
            border: 1px solid #ccc;
        }
        .btn {
            margin: 0;
        }
        .btn-primary {
            background-color: #337ab7;
            border-color: #2e6da4;
        }
        .btn-primary:hover {
            color: #fff;
            background-color: #286090;
            border-color: #204d74;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    class NAVS extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                stocks: [],
            };

            //this.init();
        }

        onChange = (e) => {
            this.setState({
                stocks: _.filter(this.props.stocks, function(stock) {
                    return stock.ISU_ABBRV.includes(e.target.value);
                }),
            });
        }

        render() {
            return (<React.Fragment>
                <div className="nav">
                    <div className="search-bar">
                        <input type="text" placeholder="종목 검색" onChange={this.onChange}/>
                    </div>
                    <div className="nav-panel">
                        <div className="panel">
                            {this.state.stocks.length != 0 ?
                                this.state.stocks.map((stock, idx) => {
                                    return (
                                        <NAV stock={stock} key={idx} setStock={this.props.setStock}/>
                                    )
                                }) : this.props.stocks.map((stock, idx) => {
                                    return (
                                        <NAV stock={stock} key={idx} setStock={this.props.setStock}/>
                                    )
                                })
                            }
                        </div>
                    </div>
                </div>
            </React.Fragment>);
        }
    }

    class NAV extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
            };
        }

        onClick = () => {
            this.props.setStock(this.props.stock);
        }

        render() {
            return (
                <React.Fragment>
                    <div className="nav-itme" onClick={() => this.onClick()}>
                        <div className="link">
                            {this.props.stock.ISU_ABBRV}
                        </div>
                    </div>
                </React.Fragment>
            );
        }
    }

    class ARTICLE2 extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                general: {},
                outline: {},
                finance: {},
            };

            this.mount();
        }

        mount = () => {
            this.props.mount( (isu_cd) => this.getDataStart(isu_cd) );
        }

        getDataStart = (isu_cd) => {
            this.getGeneral(isu_cd);
            this.getOutline(isu_cd);
            this.getFinance(isu_cd);
        }

        // 종합정보
        getGeneral = async (isuCd) => {
            await this.getData('dbms/MDC/STAT/standard/MDCSTAT02101', isuCd, null).then((responseObject) => {
                this.setState({
                    general: responseObject,
                });
            });
        }
        // 개요
        getOutline = async (isuCd) => {
            await this.getData('dbms/MDC/STAT/standard/MDCSTAT02103', isuCd, null).then((responseObject) => {
                this.setState({
                    outline: responseObject,
                });
            });
        }
        // 재무정보
        getFinance = async (isuCd) => {
            await this.getData('dbms/MDC/STAT/standard/MDCSTAT02104', isuCd, null).then((responseObject) => {
                this.setState({
                    finance: responseObject,
                });
            });
        }

        getData = (bld, isuCd,ddTp) => new Promise(function(resolve, reject) {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://yg-01-01.herokuapp.com/http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd?' +
                'bld=' + bld +
                (isuCd != null ? '&isuCd=' + isuCd : '') +
                (ddTp != null ? '&ddTp=' + ddTp : ''), true);
            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    resolve(responseObject);
                }
            };
            request.onerror = () => {
                reject();
            };
            request.send();
        });

        renderGeneral = () => {
            if (this.state.general != null)
                return (
                    <div>
                        <table className='table table-bordered'>
                            <tbody>
                                <tr>
                                    <th colSpan='2'>시가</th>
                                    <td>{this.state.general.TDD_OPNPRC}</td>
                                    <th>거래량(주)</th>
                                    <td>{this.state.general.ACC_TRDVOL}</td>
                                </tr>
                                <tr>
                                    <th colSpan='2'>고가</th>
                                    <td>{this.state.general.TDD_HGPRC}</td>
                                    <th>거래대금(원)</th>
                                    <td>{this.state.general.ACC_TRDVAL}</td>
                                </tr>
                                <tr>
                                    <th colSpan='2'>저가</th>
                                    <td>{this.state.general.TDD_LWPRC}</td>
                                    <th>시가총액(백만원)</th>
                                    <td>{this.state.general.MKTCAP}</td>
                                </tr>
                                <tr>
                                    <th rowSpan='2'>52주(종가)</th>
                                    <th>최고</th>
                                    <td>{this.state.general.WK52_HGST_PRC}</td>
                                    <th>외국인비율</th>
                                    <td>{this.state.general.FORN_RTO}</td>
                                </tr>
                                <tr>
                                    <th>최저</th>
                                    <td>{this.state.general.WK52_LWST_PRC}</td>
                                    <th>PER/PBR</th>
                                    <td>{this.state.general.PER}/{this.state.general.PBR}</td>
                                </tr>
                                <tr>
                                    <th colSpan='2'>대용가</th>
                                    <td>{this.state.general.SB_PRC}</td>
                                    <th>배당수익률</th>
                                    <td>{this.state.general.DIV_YD}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                );
        }
        renderOutline = () => {
            if (this.state.outline != null)
                return (
                    <div>
                        <table className='table table-bordered'>
                            <tbody>
                            <tr>
                                <th>한글명</th>
                                <td>{this.state.outline.ISU_NM}</td>
                                <th>영문명</th>
                                <td>{this.state.outline.ISU_ENG_NM}</td>
                            </tr>
                            <tr>
                                <th>표준코드</th>
                                <td>{this.state.outline.ISU_CD}</td>
                                <th>종목코드</th>
                                <td>{this.state.outline.ISU_SRT_CD}</td>
                            </tr>
                            <tr>
                                <th>액면가</th>
                                <td>{this.state.outline.PARVAL}</td>
                                <th>결산월</th>
                                <td>{this.state.outline.ACNTCLS_MM}</td>
                            </tr>
                            <tr>
                                <th>상장주식수(주)</th>
                                <td>{this.state.outline.LIST_SHRS}</td>
                                <th>소속부</th>
                                <td>{this.state.outline.SECT_NM}</td>
                            </tr>
                            <tr>
                                <th>상장일</th>
                                <td>{this.state.outline.LIST_DD}</td>
                                <th>설립일</th>
                                <td>{this.state.outline.FOUND_DD}}</td>
                            </tr>
                            <tr>
                                <th>업종명</th>
                                <td>{this.state.outline.IND_NM}</td>
                                <th>대표이사</th>
                                <td>{this.state.outline.CEO}</td>
                            </tr>
                            <tr>
                                <th>주소</th>
                                <td colSpan="3">{this.state.outline.ADDR}</td>
                            </tr>
                            <tr>
                                <th>전화번호</th>
                                <td colSpan="3">{this.state.outline.CORP_TEL_NO}</td>
                            </tr>
                            <tr>
                                <th>홈페이지</th>
                                <td colSpan="3">{this.state.outline.HPAGE}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                );
        }

        renderFinance = () => {
            if (this.state.finance != null)
                return (
                    <div>
                        <table className='table table-bordered'>
                            <tbody>
                            <tr>
                                <th>자산총계</th>
                                <td>{this.state.finance.ASST_TOTAMT}</td>
                                <th>매출액(수익)</th>
                                <td>{this.state.finance.SALES}</td>
                            </tr>
                            <tr>
                                <th>부채총계</th>
                                <td>{this.state.finance.DEBT_TOTAMT}</td>
                                <th>영업이익</th>
                                <td>{this.state.finance.OPERPROFT_AMT}</td>
                            </tr>
                            <tr>
                                <th>자본금</th>
                                <td>{this.state.finance.CAP}</td>
                                <th>당기순이익</th>
                                <td>{this.state.finance.NETINCM}</td>
                            </tr>
                            <tr>
                                <th>자본총계</th>
                                <td>{this.state.finance.CAP_GRNDTOT}</td>
                                <th></th>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                );
        }

        //////////////////



//////////////////////
        render() {
            return (<React.Fragment>
                <div className="article-title">
                    <div className="article-title-1">{this.state.general.ISU_NM}({this.state.general.ISU_SRT_CD}) | {this.state.general.MKT_NM}<br/></div>
                    <div className="article-title-2">{this.state.general.PRSNT_PRC} ▼{this.state.general.CMPPREVDD_PRC} ({this.state.general.FLUC_RT}%)</div>
                </div>
                <div className="article-content">
                    <div className="article-content-box">
                        <div>
                            {this.renderAi()}
                        </div>
                    </div>
                </div>
                <div className="article-content">
                    <div className="article-content-box">
                        <div>
                            <p className="container_name">종합정보</p>
                        </div>
                        <div>
                            {this.renderGeneral()}
                        </div>
                    </div>
                </div>
                <div className="article-content">
                    <div className="article-content-box">
                        <p className="container_name">
                            개요
                        </p>
                        <div>
                            {this.renderOutline()}
                        </div>
                    </div>
                </div>
                <div className="article-content">
                    <div className="article-content-box">
                        <p className="container_name">
                            재무정보
                        </p>
                        <div>
                            {this.renderFinance()}
                        </div>
                    </div>
                </div>
            </React.Fragment>);
        }
    }

    class TENSORFLOW extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                stocks: [],
                learnignRate: 0.0000000000000001,
                optimizer: tf.train.sgd(0.0000000000000001),
                m1: tf.variable(tf.scalar(Math.random(1))),
                m2: tf.variable(tf.scalar(Math.random(1))),
                m3: tf.variable(tf.scalar(Math.random(1))),
                b: tf.variable(tf.scalar(Math.random(1))),
                y: 0,
                y2: 0,
                x1s: [],
                x2s: [],
                x3s: [],
                ys: [],
                run2: 0,
                mingap: 99999999999,
                learning_magnification: 1,
                compute: 0,

                // 기본정보
                TRD_DD: '',
                TDD_CLSPRC: '',
                FLUC_TP_CD: '',
                CMPPREVDD_PRC: '',
                FLUC_RT: '',
                TDD_OPNPRC: '',
                TDD_HGPRC: '',
                TDD_LWPRC: '',
                ACC_TRDVOL: '',
                ACC_TRDVAL: '',
                MKTCAP: '',
                LIST_SHRS: ''
            }
        }

        // 학습할 데이터를 각각의 배열에 담기
        tensorinit = () => {
            this.setState((prevState) => {
                return {
                    x1s: prevState.stocks.map(value => parseInt(value.MMEND_CLSPRC.replace(/,/g , ''))), // 과거 종가
                    x2s: prevState.stocks.map(value => parseInt(value.HGST_CLSPRC.replace(/,/g , ''))), // 과거 최고가
                    x3s: prevState.stocks.map(value => parseInt(value.LWST_CLSPRC.replace(/,/g , ''))), // 과거 최저가
                    ys: prevState.stocks.map(value => parseInt(this.state.run2 ? value.LWST_CLSPRC.replace(/,/g , '') : value.HGST_CLSPRC.replace(/,/g , ''))), // 최고가 : 최저
                }
            });

            this.state.x1s.shift(); // 처음  요소 삭제
            this.state.x2s.shift(); // 처음  요소 삭제
            this.state.x3s.shift(); // 처음  요소 삭제
            this.state.ys.pop(); // 마지막 요소 삭제

            this.start(); // 계산 시작
        }

        // y 구하는 예측 식
        predict = (x1, x2, x3) => {
            const xs1 = tf.tensor(x1);
            const xs2 = tf.tensor(x2);
            const xs3 = tf.tensor(x3);

            const mx1 = xs1.mul(this.state.m1);
            const mx2 = xs2.mul(this.state.m2);
            const mx3 = xs3.mul(this.state.m3);

            const ys = mx1.add(mx2).add(mx3).add(this.state.b);

            return ys;
        }

        // pred 예측한 값이랑 labels 실제값이랑 차이
        loss = (pred, labels) => pred.sub(labels).square().mean();

        // 학습시작 ( 미니마이져를 하면서 m 값 조절 )
        start = () => {
            tf.tidy(() => {
                for(let i = 0; i < 10; i++) {
                    const ys = tf.tensor(this.state.ys); // 진짜 y
                    this.state.optimizer.minimize(() => this.loss(this.predict(this.state.x1s, this.state.x2s, this.state.x3s), ys));
                }
            });

            this.restart();
        }

        // 예측 알고리즘에 대입하여 gap 에 따라 러닝배율 조절
        restart = () => {
            // predict_y : 학습데이터의 예측값
            // ys : 학습데이터의 실제 값
            // y : 실제 데이터를 넣어 예측해보는 값

            let predict_y = Number(String(this.predict(parseFloat(this.state.x1s[0]),parseFloat(this.state.x2s[0]),parseFloat(this.state.x3s[0]))).replace('Tensor','').replace(/a/gi,""));
            let gap = Math.abs(predict_y - this.state.ys[0]);

            let x1 = parseFloat(this.state.stocks[1].MMEND_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터
            let x2 = parseFloat(this.state.stocks[1].HGST_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터
            let x3 = parseFloat(this.state.stocks[1].LWST_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터

            if(this.state.mingap > gap) {
                let gap2 = Math.abs(this.state.mingap - gap);

                this.setState((prevState) => {
                    let t = 1;
                    if(gap > 1000) {
                        t = 1.4;
                    } else if(gap > 100) {
                        t = 1.3;
                    } else if(gap > 10) {
                        t = 1.2;
                    } else if(gap > 1) {
                        t = 1.1;
                    } else if(gap > 0.1) {
                        t = 1;
                    }
                    return {
                        learning_magnification: t,
                    }
                });

                // 실시간 데이터 변경
                this.setState((prevState) => {
                    if(this.state.run2 == 2) {
                        return {
                            mingap: prevState.mingap < gap ? prevState.mingap : gap,
                            learnignRate: prevState.learnignRate * this.state.learning_magnification,
                            // 진짜 예측
                            y2: Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")),
                            optimizer: tf.train.sgd(this.state.learnignRate),
                            compute: prevState.compute+1,
                        }
                    } else {
                        return {
                            mingap: prevState.mingap < gap ? prevState.mingap : gap,
                            learnignRate: prevState.learnignRate * this.state.learning_magnification,
                            y: Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")),
                            optimizer: tf.train.sgd(this.state.learnignRate),
                            compute: prevState.compute+1,
                        }
                    }
                });

                setTimeout(() => this.start(), 1);
            } else if (this.state.compute < 5) {
                // 혹시 너무 빨리 끝났다면 다시 계산
                this.setState((prevState) => {
                    return {
                        learnignRate: prevState.learnignRate * 10,
                        optimizer: tf.train.sgd(prevState.learnignRate * 10),
                        m1: tf.variable(tf.scalar(Math.random(1))),
                        m2: tf.variable(tf.scalar(Math.random(1))),
                        m3: tf.variable(tf.scalar(Math.random(1))),
                        b: tf.variable(tf.scalar(Math.random(1))),
                        run2: prevState.run2,
                        mingap: 99999999999,
                        compute: 0,
                    }
                });

                setTimeout(() => this.start(), 1);

            } else if(this.state.run2 == 0) {
                // 최고가 계산후
                this.setState((prevState) => {
                    return {
                        learnignRate: 0.0000000000000001,
                        optimizer: tf.train.sgd(0.0000000000000001),
                        m1: tf.variable(tf.scalar(Math.random(1))),
                        m2: tf.variable(tf.scalar(Math.random(1))),
                        m3: tf.variable(tf.scalar(Math.random(1))),
                        b: tf.variable(tf.scalar(Math.random(1))),
                        x1s: [],
                        x2s: [],
                        x3s: [],
                        ys: [],
                        run2: 2,
                        mingap: 99999999999,
                        compute: 0,
                    }
                });
                this.tensorinit();
            }
        }

        // 개별종목 시세추이 (월)
        getData = () => {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://yg-01-01.herokuapp.com/http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd?' +
                'bld=dbms/MDC/STAT/standard/MDCSTAT01801&' +
                'isuCd='+this.props.stock.ISU_CD+'&' +
                'strtYymm=' + this.getCurrentDate2(5) + '&' +
                'endYymm=' + this.getCurrentDate2() + '&', true);
            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    this.setState((prevState) => {
                        return {
                            stocks: responseObject.OutBlock_1,
                        }
                    });
                    setTimeout(() => {
                        this.state.stocks.shift();
                        this.tensorinit();
                    }, 100);
                }
            };

            request.onerror = () => {};
            request.send();
        }

        // 오늘 기준으로 년도 변경
        getCurrentDate2 = (_year = 0) => {
            let date = new Date();
            date.setFullYear(date.getFullYear() - _year);

            let year = date.getFullYear().toString();
            let month = date.getMonth() + 1;
            month = month < 10 ? '0' + month.toString() : month.toString();
            let day = date.getDate();
            day = day < 10 ? '0' + day.toString() : day.toString();
            return year + month + day;
        }

        render() {
            return (
                <React.Fragment>
                    <button className="btn btn-sm btn-danger">Remove</button>
                    <button className="btn btn-sm btn-primary">Add stack</button>
                </React.Fragment>
            )
        }
    }

    class ARTICLE extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                // 예측
                stocks: [],
                learnignRate: 0.0000000000000001,
                optimizer: tf.train.sgd(0.0000000000000001),
                m1: tf.variable(tf.scalar(Math.random(1))),
                m2: tf.variable(tf.scalar(Math.random(1))),
                m3: tf.variable(tf.scalar(Math.random(1))),
                b: tf.variable(tf.scalar(Math.random(1))),
                y: 0,
                y2: 0,
                x1s: [],
                x2s: [],
                x3s: [],
                ys: [],
                run2: 0,
                mingap: 99999999999,
                learning_magnification: 1,
                compute: 0,

                // 기본정보
                TRD_DD: '',
                TDD_CLSPRC: '',
                FLUC_TP_CD: '',
                CMPPREVDD_PRC: '',
                FLUC_RT: '',
                TDD_OPNPRC: '',
                TDD_HGPRC: '',
                TDD_LWPRC: '',
                ACC_TRDVOL: '',
                ACC_TRDVAL: '',
                MKTCAP: '',
                LIST_SHRS: ''
            };
        }

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        // 학습할 데이터를 각각의 배열에 담기
        tensorinit = () => {
            this.setState((prevState) => {
                return {
                    x1s: prevState.stocks.map(value => parseInt(value.MMEND_CLSPRC.replace(/,/g , ''))), // 과거 종가
                    x2s: prevState.stocks.map(value => parseInt(value.HGST_CLSPRC.replace(/,/g , ''))), // 과거 최고가
                    x3s: prevState.stocks.map(value => parseInt(value.LWST_CLSPRC.replace(/,/g , ''))), // 과거 최저가
                    ys: prevState.stocks.map(value => parseInt(this.state.run2 ? value.LWST_CLSPRC.replace(/,/g , '') : value.HGST_CLSPRC.replace(/,/g , ''))), // 최고가 : 최저
                }
            });

            this.state.x1s.shift(); // 처음  요소 삭제
            this.state.x2s.shift(); // 처음  요소 삭제
            this.state.x3s.shift(); // 처음  요소 삭제
            this.state.ys.pop(); // 마지막 요소 삭제

            this.start(); // 계산 시작
        }

        // y 구하는 예측 식
        predict = (x1, x2, x3) => {
            const xs1 = tf.tensor(x1);
            const xs2 = tf.tensor(x2);
            const xs3 = tf.tensor(x3);

            const mx1 = xs1.mul(this.state.m1);
            const mx2 = xs2.mul(this.state.m2);
            const mx3 = xs3.mul(this.state.m3);

            const ys = mx1.add(mx2).add(mx3).add(this.state.b);

            return ys;
        }

        // pred 예측한 값이랑 labels 실제값이랑 차이
        loss = (pred, labels) => pred.sub(labels).square().mean();

        // 학습시작 ( 미니마이져를 하면서 m 값 조절 )
        start = () => {
            tf.tidy(() => {
                for(let i = 0; i < 10; i++) {
                    const ys = tf.tensor(this.state.ys); // 진짜 y
                    this.state.optimizer.minimize(() => this.loss(this.predict(this.state.x1s, this.state.x2s, this.state.x3s), ys));
                }
            });

            this.restart();
        }

        // 예측 알고리즘에 대입하여 gap 에 따라 러닝배율 조절
        restart = () => {
            // predict_y : 학습데이터의 예측값
            // ys : 학습데이터의 실제 값
            // y : 실제 데이터를 넣어 예측해보는 값

            let predict_y = Number(String(this.predict(parseFloat(this.state.x1s[0]),parseFloat(this.state.x2s[0]),parseFloat(this.state.x3s[0]))).replace('Tensor','').replace(/a/gi,""));
            let gap = Math.abs(predict_y - this.state.ys[0]);

            let x1 = parseFloat(this.state.stocks[1].MMEND_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터
            let x2 = parseFloat(this.state.stocks[1].HGST_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터
            let x3 = parseFloat(this.state.stocks[1].LWST_CLSPRC.replace(/,/g, '')); // 예측해야 될 데이터



            if(this.state.mingap > gap) {
                let gap2 = Math.abs(this.state.mingap - gap);

                this.setState((prevState) => {
                    let t = 1;
                    if(gap > 1000) {
                        t = 1.4;
                    } else if(gap > 100) {
                        t = 1.3;
                    } else if(gap > 10) {
                        t = 1.2;
                    } else if(gap > 1) {
                        t = 1.1;
                    } else if(gap > 0.1) {
                        t = 1;
                    }
                    return {
                        learning_magnification: t,
                    }
                });

                // 실시간 데이터 변경
                this.setState((prevState) => {
                    if(this.state.run2 == 2) {
                        return {
                            mingap: prevState.mingap < gap ? prevState.mingap : gap,
                            learnignRate: prevState.learnignRate * this.state.learning_magnification,
                            // 진짜 예측
                            y2: Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")),
                            optimizer: tf.train.sgd(this.state.learnignRate),
                            compute: prevState.compute+1,
                        }
                    } else {
                        return {
                            mingap: prevState.mingap < gap ? prevState.mingap : gap,
                            learnignRate: prevState.learnignRate * this.state.learning_magnification,
                            y: Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")),
                            optimizer: tf.train.sgd(this.state.learnignRate),
                            compute: prevState.compute+1,
                        }
                    }
                });

                //console.log("mingap : " + this.state.mingap);
                //console.log("gap (predict_y - ys) : " + gap);
                //console.log("gap2 (mingap - gao) : " + gap2);
                //console.log(predict_y + " - " + this.state.ys[0] + " = " + gap);


                //console.log("predict_y (학습데이터의 예측값 값) : " + Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")));
                //console.log("ys (학습데이터의 실제 값 값) : " + this.state.ys[0]);

                //console.log("y (예측해보는 값) : " + Number(String(this.predict(x1,x2,x3)).replace('Tensor','').replace(/a/gi,"")));

                //console.log("==========================");
                //console.log("learnignRate : " + this.state.learnignRate);

                setTimeout(() => this.start(), 1);
            } else if (this.state.compute < 5) {
                // 혹시 너무 빨리 끝났다면 다시 계산
                this.setState((prevState) => {
                    return {
                        learnignRate: prevState.learnignRate * 10,
                        optimizer: tf.train.sgd(prevState.learnignRate * 10),
                        m1: tf.variable(tf.scalar(Math.random(1))),
                        m2: tf.variable(tf.scalar(Math.random(1))),
                        m3: tf.variable(tf.scalar(Math.random(1))),
                        b: tf.variable(tf.scalar(Math.random(1))),
                        run2: prevState.run2,
                        mingap: 99999999999,
                        compute: 0,
                    }
                });

                setTimeout(() => this.start(), 1);

            } else if(this.state.run2 == 0) {
                // 최고가 계산후
                this.setState((prevState) => {
                    return {
                        learnignRate: 0.0000000000000001,
                        optimizer: tf.train.sgd(0.0000000000000001),
                        m1: tf.variable(tf.scalar(Math.random(1))),
                        m2: tf.variable(tf.scalar(Math.random(1))),
                        m3: tf.variable(tf.scalar(Math.random(1))),
                        b: tf.variable(tf.scalar(Math.random(1))),
                        x1s: [],
                        x2s: [],
                        x3s: [],
                        ys: [],
                        run2: 2,
                        mingap: 99999999999,
                        compute: 0,
                    }
                });

                this.tensorinit();
            }
        }

        // 개별종목 시세추이 (월)
        getData = () => {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://yg-01-01.herokuapp.com/http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd?' +
                'bld=dbms/MDC/STAT/standard/MDCSTAT01801&' +
                'isuCd='+this.props.stock.ISU_CD+'&' +
                'strtYymm=' + this.getCurrentDate2(5) + '&' +
                'endYymm=' + this.getCurrentDate2() + '&', true);
            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    this.setState((prevState) => {
                        return {
                            stocks: responseObject.OutBlock_1,
                        }
                    });
                    setTimeout(() => {
                        this.state.stocks.shift();
                        this.tensorinit();
                    }, 100);
                } else {
                    console.log('We reached our target server, but it returned an error');
                    console.log('Possibly handle the error by changing your state.');
                }
            };

            request.onerror = () => {
                console.log('There was a connection error of some sort.');
                console.log('Possibly handle the error by changing your state.');
            };

            request.send();
        }

        // 오늘 기준으로 년도 변경
        getCurrentDate2 = (_year = 0) => {
            let date = new Date();
            date.setFullYear(date.getFullYear() - _year);

            let year = date.getFullYear().toString();
            let month = date.getMonth() + 1;
            month = month < 10 ? '0' + month.toString() : month.toString();
            let day = date.getDate();
            day = day < 10 ? '0' + day.toString() : day.toString();
            return year + month + day;
        }

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        numberWithCommas = (x) => x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

        // 오늘 기준으로 년도 변경
        getCurrentDate = (_year = 0) => {
            let date = new Date();
            date.setFullYear(date.getFullYear() - _year);

            let year = date.getFullYear().toString();
            let month = date.getMonth() + 1;
            month = month < 10 ? '0' + month.toString() : month.toString();
            let day = date.getDate();
            day = day < 10 ? '0' + day.toString() : day.toString();
            return year + month + day;
        }

        // 개별 종목 시세 추이
        getAllStock = () => {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://yg-01-01.herokuapp.com/http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd?' +
                'bld=dbms/MDC/STAT/standard/MDCSTAT01701' +
                '&isuCd=' + this.props.stock.ISU_CD +
                '&strtDd=' + this.getCurrentDate() +
                '&endDd=' + this.getCurrentDate(), true);
            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    if(responseObject.output.length > 0) {
                        this.setState((prevState) => {
                            return {
                                TRD_DD: responseObject.output[0].TRD_DD,
                                TDD_CLSPRC: responseObject.output[0].TDD_CLSPRC,
                                FLUC_TP_CD: responseObject.output[0].FLUC_TP_CD,
                                CMPPREVDD_PRC: responseObject.output[0].CMPPREVDD_PRC,
                                FLUC_RT: responseObject.output[0].FLUC_RT,
                                TDD_OPNPRC: responseObject.output[0].TDD_OPNPRC,
                                TDD_HGPRC: responseObject.output[0].TDD_HGPRC,
                                TDD_LWPRC: responseObject.output[0].TDD_LWPRC,
                                ACC_TRDVOL: responseObject.output[0].ACC_TRDVOL,
                                ACC_TRDVAL: responseObject.output[0].ACC_TRDVAL,
                                MKTCAP: responseObject.output[0].MKTCAP,
                                LIST_SHRS: responseObject.output[0].LIST_SHRS,
                            }
                        });
                    } else {

                    }
                } else {
                    console.log('We reached our target server, but it returned an error');
                    console.log('Possibly handle the error by changing your state.');
                }
            };

            request.onerror = () => {
                console.log('There was a connection error of some sort.');
                console.log('Possibly handle the error by changing your state.');
            };

            request.send();
        }

        render() {
            return (<React.Fragment>
                <div className="shadow-lg card mb-2 bg-white rounded" onClick={this.getAllStock}>
                    <div className="card-body">
                        <div className="row">
                            <div className="col-sm-6">
                                <span className="badge badge-secondary">{this.props.stock.ISU_SRT_CD}</span>&nbsp;
                                <span className="badge badge-secondary">{this.props.stock.MKT_TP_NM}</span>
                                <p className="h6">{this.props.stock.ISU_NM}</p>
                                <div>
                                    시가 <strong className="h5" style={{color:'var(--danger)'}}>{this.state.TDD_OPNPRC}</strong>&nbsp;&nbsp;
                                    거래량 <strong className="h5">{this.state.ACC_TRDVOL}</strong>
                                </div>
                            </div>
                            <div className="col-sm-6">
                                <div>이번달 최고가 예측 <strong className="h5" style={{color:'var(--danger)'}}>{this.numberWithCommas(Math.round(this.state.y))}원</strong></div>
                                <div>이번달 최저가 예측 <strong className="h5">{this.numberWithCommas(Math.round(this.state.y2))}원</strong></div>
                                <div className="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" className="btn btn-danger btn-sm"
                                            data-toggle="collapse"
                                            role="button"
                                            aria-expanded="false"
                                            onClick={this.getData}
                                    >예측</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </React.Fragment>);
        }
    }


    class A extends React.Component {
        constructor(props) {
            super(props);

            this.state = {
                allstocks: [],
                stock: {},
                childFunc: {},
            };


            this.getAllStock();
        }

        setStock = (stock) => {
            this.setState(prevState => {
                return {
                    stock: stock,
                }
            });
            this.childFunc(stock.ISU_CD);
        }

        mount = (childFunc) => {
            this.childFunc = childFunc;
        }

        // 전종목 기본정보
        getAllStock = () => {
            let request = new XMLHttpRequest();

            request.open('GET', 'https://yg-01-01.herokuapp.com/http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd?bld=dbms/MDC/STAT/standard/MDCSTAT01901&mktId=ALL', true);
            request.onload = (e) => {
                if (request.status >= 200 && request.status < 400) {
                    let responseObject = JSON.parse(request.responseText);
                    this.setState((prevState) => {
                        return {
                            allstocks: responseObject.OutBlock_1,
                        }
                    });
                } else {
                    console.log('We reached our target server, but it returned an error');
                    console.log('Possibly handle the error by changing your state.');
                }
            };

            request.onerror = () => {
                console.log('There was a connection error of some sort.');
                console.log('Possibly handle the error by changing your state.');
            };

            request.send();
        }



        render() {
            return (<React.Fragment>
                <NAVS stocks={this.state.allstocks} setStock={this.setStock}/>
                <div className="article">
                    <ARTICLE2 stock={this.state.stock} mount={this.mount}/>
                </div>
            </React.Fragment>);
        }
    }

</script>

<script type="text/babel">
    ReactDOM.render(<A/>, document.querySelector('#root'));
</script>
</body>
</html>
